<!-- {{define "hello"}}Hello, {{.}}!{{end}} -->

<!DOCTYPE html>
<html>
    <head>
        {{.Title}}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <div id="main" style="position: relative; width: 300px; display: grid; grid-template-columns: 350px 350px 350px;">
        </div>
          <script>
            var users = new Map();
            var initChart = function(d, playerID, canvID) {
                    const data = {
                    labels: [
                        'Eng',
                        'Weap',
                        'Sys'  
                    ],
                
                    datasets: [{
                        label: playerID,
                        data: d,
                        fill: true,
                        backgroundColor: 'rgba(0, 0, 255, 0.5)',
                        borderColor: 'rgb(0, 255, 0)',
                        pointBackgroundColor: 'rgb(0, 255, 0)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(255, 99, 132)'
                    }]
                    };
                const config = {
                    type: 'radar',
                    data: data,
                    options: {
                        scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 10
                        }
                    },
                        elements: {
                        line: {
                            borderWidth: 1
                        }
                        }
                    },
                    };
                    
                var myChart = new Chart(
                    document.getElementById(canvID),
                    config
                );
                return myChart;
            };
            // var evtSource = new EventSource('https://edservertest.herokuapp.com/eventTest?stream=test');
            var evtSource = new EventSource('http://localhost:1488/eventTest');

            evtSource.onmessage = function(event) {
                let dataEvent = JSON.parse(event.data);
                if (dataEvent.delete) {
                    var p = document.getElementById('main');
                    var ch = document.getElementById(dataEvent.player);
                    if (ch.parentNode) {
                        ch.parentNode.removeChild(ch);
                    }
                    users.get(dataEvent.player).destroy();
                    console.log(users.has(dataEvent.player),users.delete(dataEvent.player));
                    console.log(users)
                    return
                }
                for (const x in dataEvent) {
                    var d = [parseInt(dataEvent[x].Eng, 10), parseInt(dataEvent[x].Wep, 10), parseInt(dataEvent[x].Sys, 10)];
                    if (users.has(x)) {
                        let chart = users.get(x);
                        chart.data.datasets[0].data = d;
                        chart.update();
                    } else {
                        var p = document.getElementById('main');
                        var newEl = document.createElement('canvas');
                        newEl.setAttribute('id', dataEvent[x].player);
                        p.appendChild(newEl);
                        users.set(x,initChart(d, dataEvent[x].player, dataEvent[x].player));
                    }

                }
            }

          </script>
    </body>
</html>